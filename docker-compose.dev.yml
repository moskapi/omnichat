version: "3.9"

services:
  backend:
    build: ./backend
    container_name: omnichat-backend
    command: sh -lc "pip install -r /app/requirements.txt && python manage.py runserver 0.0.0.0:8000"
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    environment:
      DJANGO_DEBUG: "1"
      DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1
      DJANGO_CSRF_TRUSTED_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      CORS_ALLOWED_ORIGINS: http://localhost:5173

      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"

      REDIS_URL: redis://redis:6379/0

      EVOLUTION_BASE_URL: http://evolution:8080
      EVOLUTION_API_KEY: dev_key

      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      OPENAI_EMBED_MODEL: ${OPENAI_EMBED_MODEL}
      OPENAI_CHAT_MODEL: ${OPENAI_CHAT_MODEL}
    depends_on:
      - db
      - redis
      - evolution

  db:
    image: pgvector/pgvector:pg16
    container_name: omnichat-db
    environment:
      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: omnichat-redis

  mongodb:
    image: mongo:6
    container_name: omnichat-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    volumes:
      - mongodata:/data/db

  evolution:
    image: atendai/evolution-api:v1.8.2
    container_name: omnichat-evolution
    depends_on:
      - mongodb
      - redis
    environment:
      AUTHENTICATION_TYPE: apikey
      AUTHENTICATION_API_KEY: dev_key

      DATABASE_ENABLED: "true"
      DATABASE_CONNECTION_URI: mongodb://root:root@mongodb:27017/?authSource=admin

      SERVER_URL: http://evolution:8080

      WEBHOOK_GLOBAL_ENABLED: "true"
      WEBHOOK_GLOBAL_URL: "http://backend:8000/api/v1/providers/evolution/webhook/"
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: "false"

      LOG_LEVEL: "debug"
    ports:
      - "8081:8080"

volumes:
  pgdata:
  mongodata:
