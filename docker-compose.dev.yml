version: "3.9"

services:
  backend:
    build: ./backend
    container_name: omnichat-backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    environment:
      # Django
      DJANGO_DEBUG: "1"
      DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1
      DJANGO_CSRF_TRUSTED_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      CORS_ALLOWED_ORIGINS: http://localhost:5173

      # Database (backend)
      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"

      # Redis (backend)
      REDIS_URL: redis://redis:6379/0

      # Evolution (client backend â†’ evolution)
      EVOLUTION_BASE_URL: http://evolution:8080
      EVOLUTION_API_KEY: dev_key
    depends_on:
      - db
      - redis

  db:
    image: postgres:16
    container_name: omnichat-db
    environment:
      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat
    volumes:
      - pgdata:/var/lib/postgresql/data
    

  redis:
    image: redis:7
    container_name: omnichat-redis

  evolution:
    image: atendai/evolution-api:latest
    container_name: omnichat-evolution
    depends_on:
      - db
      - redis
    environment:
      # Auth
      AUTHENTICATION_TYPE: apikey
      AUTHENTICATION_API_KEY: dev_key

      # Database (Evolution)
      DATABASE_ENABLED: "true"
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://omnichat:omnichat@db:5432/evolution

      # Redis (Evolution v2)
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: "redis://redis:6379/0"
      CACHE_REDIS_PREFIX_KEY: "omnichat"
      CACHE_REDIS_SAVE_INSTANCES: "false"

      QRCODE_LIMIT: "10"
      QRCODE_COLOR: "#000000"
      QRCODE_QUALITY: "high"

      #API KEY
      EVOLUTION_API_KEY: "omnichat-dev-key"

    ports:
      - "8081:8080"

volumes:
  pgdata:
