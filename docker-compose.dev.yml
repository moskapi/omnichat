services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  evolution:
    image: atendai/evolution-api:latest
    environment:
      AUTHENTICATION_TYPE: apikey
      AUTHENTICATION_API_KEY: dev_key
    ports:
      - "8080:8080"

  backend:
    build:
      context: ./backend
    env_file:
      - ./backend/.env
    environment:
      # DB e Redis apontando pros services
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_DB: omnichat
      POSTGRES_USER: omnichat
      POSTGRES_PASSWORD: omnichat

      REDIS_URL: redis://redis:6379/0

      # Evolution apontando pro service interno (n√£o localhost!)
      EVOLUTION_BASE_URL: http://evolution:8080
      EVOLUTION_API_KEY: dev_key
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
      - evolution
    volumes:
      - ./backend:/app
    

volumes:
  pgdata:
