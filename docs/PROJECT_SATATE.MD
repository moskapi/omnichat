

üìå Omnichat ‚Äî Project State (Snapshot T√©cnico)
1) Vis√£o Geral do Produto

Omnichat √© uma plataforma SaaS omnichannel (WhatsApp + IA + RAG), multi-tenant, API-first.

Objetivo:

Transformar canais (ex: WhatsApp) em agentes especialistas via RAG + LLM.

Oferecer API para desenvolvedores e empresas.

Suportar multi-tenant (Workspaces).

Ter rastreabilidade, idempot√™ncia, audit e billing.

Stack:

Backend: Django + DRF

Frontend: React + TypeScript (Lovable)

Arquitetura: API-first, multi-tenant, modular por apps.

2) Estrutura do Backend (Django)
Projeto Django
backend/
  setup/        # projeto Django (settings, urls, asgi, wsgi)
  apps/          # apps modulares

Apps existentes
apps/
  core/
  tenants/
  authx/
  channels/
  conversations/
  messages/
  agents/
  rag/
  webhooks/
  audit/
  providers/
    base/
    evolution/
    whatsapp_official/

INSTALLED_APPS

rest_framework

apps.core

apps.tenants

apps.authx

apps.channels

apps.webhooks

apps.conversations

apps.messages

apps.agents

apps.rag

apps.audit

3) Conven√ß√µes de Plataforma
Estrutura

Backend: backend/

Projeto Django: backend/setup/

Apps: backend/apps/<app>/

API prefixo: /api/v1/

Multi-tenant

Termo oficial: Workspace

Header padr√£o: X-Workspace-ID

PK padr√£o: UUID

Imports

Padr√£o: from apps.<app>.models import ...

4) API Router
setup/api/urls.py

Todos os apps s√£o expostos em:

/api/v1/
  tenants/
  auth/
  channels/
  webhooks/
  conversations/
  messages/
  agents/
  rag/
  audit/

5) Pipeline Oficial (Webhook ‚Üí Resposta)

Documento: docs/PIPELINE.md

Resumo:

Webhook inbox

Valida√ß√£o

Idempot√™ncia

Normaliza√ß√£o

Resolu√ß√£o Workspace/Channel

Persist√™ncia (Contact/Conversation/Message IN)

Sele√ß√£o Agent

RAG retrieval

Execu√ß√£o LLM

Persist√™ncia Message OUT

Envio provider

Usage + Audit + Trace

6) Webhooks (Primeiro Core Real da Plataforma)
Endpoint can√¥nico
POST /api/v1/webhooks/inbox/

Implementa√ß√£o atual (DRF)
Model

apps.webhooks.models.WebhookEvent

Campos:

id (UUID, PK)

created_at (datetime)

provider (string)

idempotency_key (string, indexed)

raw_payload (JSON)

raw_headers (JSON)

normalized (JSON, opcional)

Serializer

WebhookEventSerializer

Responsabilidades:

validar payload

gerar idempotency_key se n√£o fornecido

normalizar entrada b√°sica

View

WebhookInboxView (APIView)

L√≥gica:

valida request via serializer

aplica idempot√™ncia:

se idempotency_key j√° existe ‚Üí retorna {ok: true, idempotent: true}

sen√£o ‚Üí cria WebhookEvent e retorna {ok: true, idempotent: false}

URLs

apps.webhooks.urls

path("inbox/", WebhookInboxView.as_view(), name="webhooks-inbox")

Admin

WebhookEvent registrado no Django Admin.

Tests

Testes DRF:

cria evento

garante idempot√™ncia

7) Estado Atual do C√≥digo
Implementado ‚úÖ

Arquitetura modular por apps

API versionada (/api/v1)

Pipeline documentado

Webhook inbox real

Persist√™ncia de eventos

Idempot√™ncia

Testes

Conven√ß√µes do repo (docs/CONVENTIONS.md)

Snapshot de arquitetura (docs/PIPELINE.md)

Ainda n√£o implementado ‚ùå

(Core da plataforma)

Multi-tenant real (tenants)

Workspace

Membership

ApiKey

Middleware de resolu√ß√£o de Workspace

Channels

Channel model

Binding com provider (WhatsApp)

Credenciais

Conversations / Messages

Contact

Conversation

Message

Rela√ß√£o com Channel + Workspace

Agents

Agent

AgentVersion

AgentRun

RAG

KnowledgeBase

Document

Chunk

Embeddings

Usage / Billing

UsageRecord

Quotas

Planos

8) Decis√µes Arquiteturais Importantes

DRF como camada API padr√£o.

UUID como PK para entidades de plataforma.

WebhookEvent como ‚Äúentrada can√¥nica‚Äù do sistema.

Idempot√™ncia obrigat√≥ria em webhooks.

Multi-tenant baseado em Workspace (n√£o Tenant).

Pipeline orientado a eventos.

Providers desacoplados (interface base).

9) Roadmap T√©cnico (ordem correta)
Fase 5 ‚Äî Core Platform

Workspace (multi-tenant real) ‚Üê pr√≥ximo passo

ApiKey + Auth de Workspace

Channel + Provider binding

Contact / Conversation / Message

Agent layer

RAG layer

Usage / Billing

10) Pr√≥ximo passo imediato

üëâ Implementar Workspace, Membership e ApiKey em apps.tenants.

Objetivo:

Criar base multi-tenant real.

Permitir que qualquer request perten√ßa a um Workspace.

Preparar API para SaaS e monetiza√ß√£o.